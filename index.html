<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style>

    </style>
</head>

<body style="display:flex;">
    <div id="layer-box" style=" width: 500px; height: 500px;position: relative">
        <img style="width: 100%; height: 100%; position: absolute" src="https://p0.ssl.qhimg.com/t01989f0d446bed3e58.jpg" />
    </div>
    <div id="save" @click="save" style="margin-top: 20px;margin-right: 20px; margin-left: 20px;">保存</div>
    <canvas id="mergedCanvas" style="border:1px solid #000;"></canvas>
    <script>

        // 存储各个图层图片信息
        let layers = []
        // 选择layer的index
        const selectedIndexList = []


        // 点击保存
        document.getElementById('save').onclick = function () {
            const images = [];
            selectedIndexList.forEach(index => {
                images.push(layers[index].imageData)
            })
            drawing(images)
        }

        /**
           * 图片合成
           */
        function drawing(images) {
            const canvas = document.getElementById("mergedCanvas");
            canvas.width = 500;  // 设置canvas宽
            canvas.height = 500; // 设置canvas高
            const ctx = canvas.getContext("2d");
            let loadedImages = 0;
            images.forEach(function (src) {
                const img = new Image();
                img.src = src;
                img.onload = function () {
                    loadedImages++;

                    // 绘制每张图片到 canvas 上
                    ctx.drawImage(img, 0, 0);

                    // 如果所有图片都加载完成，保存合并后的图片
                    if (loadedImages === images.length) {
                        const mergedImage = canvas.toDataURL("image/png");
                        // console.log("Merged Image Data URL:", mergedImage);
                        // 如果需要，你可以将数据 URL 用于其他操作，比如显示在页面上或发送到服务器
                    }
                };
            });
        }



        /**
         * rle格式图片信息转换为mask信息
         */
        function rle2mask(mask_rle, shape = [500, 500]) {
            /*
            mask_rle: run-length as string formatted (start length)
            shape: [width, height] of array to return
            Returns an array, 1 - mask, 0 - background
            */

            const s = mask_rle.split(" ");
            let starts = s.filter((_, index) => index % 2 === 0).map(Number);
            const lengths = s.filter((_, index) => index % 2 !== 0).map(Number);
            starts = starts.map(start => start - 1);
            const ends = starts.map((start, index) => start + lengths[index]);
            const img = new Array(shape[0] * shape[1]).fill(0);

            for (let i = 0; i < starts.length; i++) {
                for (let j = starts[i]; j < ends[i]; j++) {
                    img[j] = 1;
                }
            }

            // return transposeArray(img, shape);
            const transposed = new Array(shape[1]).fill(0).map(() => new Array(shape[0]).fill(0));
            for (let i = 0; i < shape[0]; i++) {
                for (let j = 0; j < shape[1]; j++) {
                    transposed[j][i] = img[i * shape[1] + j];
                }
            }
            return transposed;
        }


        /**
         * 转换mask图片信息，并设置mask的填充颜色
         */
        function transformMaskImage(item, _width, _height) {
            let canvas = document.createElement("canvas");
            let canvasContext = canvas.getContext("2d");
            canvas.width = _width;
            canvas.height = _height;
            let rgbaData = rle2mask(item.mask || '', [_width, _height])
            for (let y = 0; y < rgbaData.length; y++) {
                let row = rgbaData[y];
                for (let x = 0; x < row.length; x++) {
                    let dot = rgbaData[y][x];
                    if (1 === dot && canvasContext) {
                        // 值为1的点填充颜色
                        (canvasContext.fillStyle = "#4169eb"), canvasContext.fillRect(x, y, 1, 1);
                    }
                }
            }
            // canvas当前层的图片（base64格式）
            // matrix：上边生成的二维数组
            return { imageData: canvas.toDataURL("image/png"), matrix: rgbaData };
        }

        // 使用sam处理后的图层信息（rle编码后的）
        const res = { "height": 500, "width": 500, "mask_list": [{ "index": 0, "mask": "109864 3 110361 7 110860 9 111359 10 111859 10 112359 10 112860 9 113360 10 113860 10 114360 10 114860 10 115360 10 115861 8" }, { "index": 1, "mask": "121910 2 122409 4 122908 6 123408 7 123907 8 124407 9 124907 9 125406 11 125905 12 126404 13 126905 12 127405 12 127906 12 128406 12 128907 11 129407 10 129908 8 130408 4" }, { "index": 2, "mask": "108429 5 108923 11 109422 13 109921 14 110421 14 110922 12 111422 13 111922 14 112421 15 112920 17 113420 17 113920 16 114421 15 114922 14 115423 12 115926 8" }, { "index": 3, "mask": "159396 17 159894 19 160393 20 160892 20 161391 21 161891 21 162391 21 162891 21 163391 20 163892 16 164394 13 164899 7 165399 6 165901 4" }, { "index": 4, "mask": "136915 2 137414 4 137910 1 137913 7 138408 13 138907 15 139407 15 139906 17 140405 18 140905 18 141405 18 141905 18 142405 18 142905 18 143405 18 143905 18 144405 14 144906 12 145408 9 145910 6 146413 2" }, { "index": 5, "mask": "108341 6 108839 11 109338 13 109837 14 110336 16 110836 17 111336 17 111836 18 112336 18 112836 18 113336 18 113836 17 114336 17 114837 16 115337 15 115839 13 116341 11 116843 7" }, { "index": 6, "mask": "131885 10 132383 14 132882 16 133381 18 133881 18 134381 18 134880 19 135380 19 135880 18 136381 16 136881 16 137382 15 137883 14 138383 14 138883 14 139384 13 139885 12 140387 10 140889 7 141391 4 141892 2" }, { "index": 7, "mask": "108401 4 108412 2 108898 17 109396 20 109895 22 110393 23 110892 22 111391 22 111890 22 112390 22 112889 23 113389 22 113890 21 114390 20 114891 18 115392 1 115395 11 115896 9 116397 6" }, { "index": 8, "mask": "161451 13 161949 16 162449 16 162949 16 163449 16 163949 17 164449 18 164949 18 165449 19 165949 19 166449 20 166949 20 167448 21 167948 22 168447 23 168948 22 169448 22 169948 22 170450 20 170952 18 171453 17 171954 16 172454 15 172956 11 173464 2" }, { "index": 9, "mask": "118385 6 118879 19 118899 2 119377 26 119876 27 120375 29 120875 29 121375 30 121876 29 122378 27 122879 27 123380 25 123881 24 124381 23 124881 22 125382 20 125883 18 126383 18 126885 15 127386 14 127888 11 128390 6" }, { "index": 10, "mask": "114761 3 115259 4 115759 4 116258 5 116758 5 117258 5 117757 6 118257 6 118757 6 119257 6 119757 5 120257 5 120756 6 121256 6 121756 6 122256 6 122756 5 123256 5 123756 5 124256 5 124756 5 125256 6 125756 6 126256 6 126756 6 127256 6 127756 6 128256 6 128756 6 129256 6 129756 6 130256 6 130756 6 131257 5 131757 5 132257 6 132757 6 133257 6 133757 6 134257 6 134757 6 135257 6 135757 6 136257 6 136757 6 137257 6 137757 6 138257 6 138758 5 139258 6 139758 6 140258 6 140758 6 141258 6 141758 6 142259 6 142759 6 143259 6 143759 6 144259 6 144759 6 145260 5 145760 6 146260 6 146760 6 147260 6 147760 7 148261 6 148761 6 149261 6 149761 7 150262 6 150762 7 151262 7 151762 7 152262 8 152763 7 153263 8 153763 8 154264 8 154765 7 155265 8 155766 7 156267 7 156767 7 157268 5" }, { "index": 11, "mask": "95994 7 96486 15 96986 15 97485 16 97985 16 98485 16 98985 16 99485 16 99985 16 100485 16 100985 16 101485 16 101985 16 102485 16 102985 16 103485 16 103985 16 104485 16 104984 17 105484 17 105983 18 106483 18 106983 18 107482 19 107982 19 108482 19 108982 19 109482 19 109982 19 110482 19 110982 19 111481 20 111981 20 112481 20 112981 20 113481 20 113982 19 114482 19 114982 19 115482 19 115982 19 116483 18 116983 18 117483 18 117984 17 118484 17 118984 17 119484 17 119985 16 120486 1" }, { "index": 12, "mask": "120990 11 121488 13 121987 14 122488 13 122988 13 123488 13 123989 12 124489 12 124989 12 125490 11 125990 11 126490 11 126990 11 127491 10 127991 10 128491 10 128991 10 129491 10 129991 10 130491 10 130991 10 131491 10 131992 9 132492 9 132992 9 133492 9 133992 9 134492 9 134993 8 135493 8 135993 8 136493 8 136994 7 137494 7 137994 7 138494 7 138994 7 139494 7 139994 7 140494 7 140994 7 141494 7 141994 7 142494 7 142994 7 143494 7 143993 8 144493 8 144993 8 145493 8 145993 8 146493 8 146993 8 147493 8 147993 8 148493 8 148993 8 149493 8 149993 8 150493 8 150994 7 151494 7 151994 7 152494 7 152994 7 153494 7 153994 7 154494 7 154994 7 155494 7 155994 7 156494 7 156994 7 157493 8 157993 8 158493 8 158993 8 159493 8 159993 8 160493 8 160992 9 161492 9 161992 9 162491 10 162990 11 163490 11 163990 11 164490 11 164990 11 165490 11 165990 11 166490 11 166990 11 167490 11 167990 11 168491 10 168992 9 169494 7 169996 5 170498 3 170999 2" }, { "index": 13, "mask": "169488 4 169988 5 170488 7 170987 10 171487 11 171987 14 172486 15 172986 15 173486 15 173986 15 174485 16 174985 16 175485 16 175984 17 176484 17 176984 17 177483 18 177982 19 178482 19 178982 19 179481 20 179981 20 180480 21 180980 21 181479 22 181978 23 182478 23 182977 24 183476 25 183975 26 184474 27 184974 27 185473 28 185973 28 186472 29 186972 29 187471 30 187971 30 188470 31 188970 31 189469 32 189969 32 190469 32 190968 33 191468 33 191969 32 192471 30 192973 28 193475 26 193977 24 194479 22 194981 20 195483 18 195985 16 196487 14 196989 12" }, { "index": 14, "mask": "95998 3 96488 13 96986 15 97486 15 97986 15 98486 15 98986 15 99486 15 99986 15 100486 15 100986 15 101486 15 101986 15 102486 15 102985 16 103485 16 103985 16 104485 16 104985 16 105484 17 105984 17 106483 18 106983 18 107483 18 107983 18 108483 18 108982 19 109482 19 109982 19 110482 19 110982 19 111481 20 111981 20 112481 20 112981 20 113481 20 113982 19 114482 19 114982 19 115482 19 115982 19 116483 18 116983 18 117483 18 117983 18 118484 17 118984 17 119484 17 119985 14 120486 3 168988 2 169488 4 169988 6 170487 9 170987 10 171487 12 171987 14 172486 15 172986 15 173486 15 173985 16 174485 16 174985 16 175484 17 175984 17 176484 17 176983 18 177483 18 177982 19 178482 19 178981 20 179481 20 179981 20 180480 21 180980 21 181479 22 181978 23 182478 23 182977 24 183476 25 183975 26 184474 27 184974 27 185473 28 185972 29 186472 29 186972 29 187471 30 187971 30 188470 31 188970 31 189469 32 189969 32 190468 33 190968 33 191468 33 191969 32 192471 30 192973 28 193475 26 193977 24 194479 22 194981 20 195483 18 195985 16 196487 14 196990 11" }, { "index": 15, "mask": "116626 12 117121 16 117618 19 118114 24 118611 27 119109 29 119605 35 120084 58 120578 64 121076 67 121574 69 122073 70 122571 73 123070 75 123569 78 124067 85 124566 87 125065 88 125564 90 126062 92 126561 94 127060 96 127559 98 128058 101 128558 102 129057 103 129556 105 130055 106 130554 107 131053 108 131552 109 132051 72 132133 28 132551 69 132637 24 133050 69 133141 21 133550 69 133646 16 134049 70 134149 13 134549 69 134651 12 135049 69 135153 10 135549 69 135655 9 136049 68 136157 7 136549 68 136658 6 137049 67 137159 5 137549 66 137660 4 138049 65 138162 2 138550 62 139050 61 139550 60 140050 57 140550 56 141051 52 141552 50 142053 46 142554 43 143056 39 143559 32 144065 15" }, { "index": 16, "mask": "103203 3 103702 7 104202 10 104702 13 105202 16 105702 18 106202 20 106701 22 107200 24 107699 26 108198 29 108697 32 109195 37 109694 41 110193 46 110692 51 111191 53 111691 56 112190 58 112689 61 113187 64 113684 69 114183 71 114683 75 115182 76 115682 76 116182 76 116682 76 117181 77 117680 77 118177 80 118675 82 119173 84 119672 85 120171 86 120671 85 121169 87 121668 88 122168 88 122666 90 123164 92 123663 93 124160 96 124657 99 125156 100 125656 100 126157 99 126657 99 127158 98 127660 96 128161 95 128661 95 129162 94 129662 94 130162 94 130662 94 131162 95 131663 94 132163 94 132663 94 133163 94 133663 94 134163 94 134664 93 135164 93 135665 92 136165 92 136665 92 137165 92 137666 91 138166 91 138665 92 139165 93 139664 94 140164 94 140663 95 141163 95 141664 94 142164 94 142664 95 143165 94 143665 94 144165 94 144666 93 145166 93 145667 92 146167 93 146667 93 147167 93 147667 93 148167 94 148668 93 149168 93 149668 93 150169 92 150669 93 151170 92 151671 91 152173 90 152675 88 153178 85 153679 85 154181 83 154682 83 155183 83 155685 81 156187 80 156689 78 157193 72 157696 65 158201 57 158711 1 158713 41" }, { "index": 17, "mask": "92138 6 92636 10 93134 14 93632 19 94131 22 94630 25 95105 1 95129 28 95602 16 95628 31 96100 20 96126 35 96597 65 97094 69 97593 71 98091 74 98590 76 99089 77 99588 79 100087 82 100586 84 101085 85 101584 87 102082 90 102580 94 103078 97 103561 116 104058 121 104556 124 105054 127 105552 130 106051 132 106549 135 107047 138 107546 140 108045 142 108543 145 109042 147 109541 149 110040 150 110539 151 111038 151 111537 150 112036 149 112535 149 113034 148 113533 148 114033 148 114532 149 115032 149 115531 108 115642 39 116031 103 116140 40 116531 94 116640 40 117030 91 117140 38 117530 88 117640 36 118030 84 118140 34 118529 82 118641 31 119029 80 119142 29 119528 76 119642 28 120028 55 120142 28 120528 51 120642 27 121028 49 121143 26 121527 47 121643 25 122027 46 122144 23 122527 44 122645 20 123026 43 123146 17 123526 42 123653 8 124026 41 124526 40 125026 39 125526 38 126025 37 126525 36 127025 35 127525 35 128026 33 128526 32 129026 31 129526 30 130026 29 130526 28 131027 26 131527 25 132027 24 132128 1 132527 24 132621 16 133027 23 133119 22 133528 22 133619 26 134028 22 134119 30 134528 21 134618 32 135029 20 135118 36 135529 20 135618 37 136030 20 136117 40 136531 19 136617 40 137031 19 137116 42 137532 18 137615 44 138032 18 138114 47 138533 17 138612 50 139034 16 139110 52 139534 16 139610 52 140035 15 140107 55 140536 14 140605 57 141037 14 141103 59 141537 15 141602 61 142038 15 142099 64 142539 16 142597 67 143041 15 143094 70 143542 16 143591 74 144043 21 144082 83 144544 121 145046 119 145548 118 146050 116 146553 113 147057 109 147561 106 148065 102 148569 98 149072 95 149574 93 150076 92 150578 91 151079 91 151581 38 151625 45 152082 34 152127 45 152628 45 153128 48 153629 49 154129 51 154630 51 155130 51 155631 51 156131 53 156632 52 157133 51 157634 18 157655 29 158135 15 158156 27 158636 13 158657 26 159137 10 159157 26 159638 7 159658 25 160158 24 160659 23 161160 22 161661 20 162162 17 162664 13 163165 9 163668 3" }, { "index": 18, "mask": "54242 7 54740 10 55237 15 55735 18 56234 20 56732 23 57231 25 57729 28 58228 31 58726 34 59225 36 59724 37 60222 40 60721 42 61220 44 61719 46 62217 49 62716 51 63215 53 63714 55 64213 57 64712 58 65211 60 65709 63 66208 65 66707 67 67206 69 67705 71 68204 73 68703 74 69202 76 69700 79 70199 81 70698 83 71197 84 71696 44 71745 37 72195 43 72247 36 72695 42 72749 35 73194 42 73250 34 73693 41 73751 34 74192 41 74252 34 74691 42 74753 33 75190 41 75254 33 75689 41 75755 33 76189 40 76256 32 76688 40 76757 32 77187 40 77258 32 77686 40 77759 32 78185 40 78260 31 78684 41 78761 31 79183 41 79262 31 79682 41 79763 30 80181 41 80264 30 80680 41 80765 30 81178 41 81266 29 81677 41 81767 29 82176 41 82268 29 82675 41 82769 28 83173 42 83270 28 83672 42 83771 28 84171 42 84272 28 84669 43 84773 27 85168 43 85274 27 85667 43 85775 27 86166 43 86275 27 86665 43 86776 27 87164 43 87277 27 87663 43 87777 27 88162 43 88278 27 88660 44 88779 27 89159 44 89280 27 89659 43 89780 27 90158 43 90281 27 90657 43 90782 26 91156 43 91282 27 91655 43 91783 26 92154 44 92284 26 92653 43 92785 26 93152 44 93286 26 93653 42 93786 26 94154 40 94287 26 94655 39 94788 25 95157 36 95288 26 95659 34 95789 25 96160 33 96290 25 96662 31 96790 25 97163 30 97291 24 97664 29 97792 24 98165 28 98292 24 98666 28 98793 23 99167 28 99293 23 99668 28 99794 22 100169 28 100294 22 100670 28 100794 21 101171 28 101293 22 101672 27 101793 21 102173 27 102292 22 102674 26 102790 23 103175 26 103289 24 103677 24 103788 25 104179 22 104287 26 104680 21 104786 27 105182 19 105285 28 105683 18 105785 28 106183 18 106284 30 106684 17 106783 31 107185 15 107282 32 107687 12 107781 34 108188 9 108280 35 108688 7 108779 36 109191 3 109280 35 109780 35 110281 35 110781 35 111283 33 111783 33 112283 33 112784 32 113284 31 113785 29 114285 28 114786 27 115287 26 115787 25 116134 5 116288 24 116626 13 116789 22 117121 17 117290 19 117617 21 117791 18 118113 25 118292 16 118610 29 118794 13 119107 34 119299 1 119301 5 119588 54 120081 61 120578 65 121075 69 121574 70 122072 73 122571 74 123069 77 123568 83 124067 86 124566 88 125064 90 125563 91 126062 93 126561 95 127060 97 127559 100 128058 102 128557 104 129056 105 129555 106 130054 107 130553 109 131052 110 131551 111 132051 75 132132 30 132550 71 132637 25 133050 69 133141 21 133550 69 133645 17 134049 70 134148 15 134549 69 134650 13 135049 69 135153 11 135549 69 135655 9 136049 69 136157 7 136549 68 136658 7 137049 67 137159 6 137549 66 137660 5 138049 65 138161 4 138549 64 139049 62 139550 60 140050 58 140550 56 141051 52 141551 51 142052 48 142554 43 143056 39 143559 32 144062 25" }, { "index": 19, "mask": "92138 6 92636 10 93134 14 93632 18 94131 22 94630 25 95104 4 95129 28 95601 17 95628 31 96100 20 96126 34 96597 64 97094 69 97592 72 98091 74 98590 75 99089 77 99588 79 100087 82 100586 83 101085 85 101583 89 102082 91 102580 94 103077 98 103561 116 104058 121 104556 124 105054 127 105552 130 106050 133 106549 135 107047 138 107546 140 108045 142 108543 145 109042 147 109541 148 110040 149 110539 150 111038 151 111537 150 112036 150 112535 149 113034 149 113533 148 114033 148 114532 149 115032 149 115531 150 116031 106 116139 41 116530 96 116639 41 117030 91 117140 38 117530 88 117640 35 118029 85 118140 34 118529 82 118640 33 119029 81 119142 29 119528 76 119642 28 120028 56 120142 28 120528 51 120642 27 121027 49 121143 26 121527 47 121644 23 122027 46 122144 22 122527 44 122645 20 123026 44 123146 17 123526 43 123653 8 124026 41 124526 40 125026 39 125525 39 126025 38 126525 37 127025 36 127525 35 128025 34 128526 32 129026 31 129526 30 130026 29 130526 28 131026 27 131527 25 132027 25 132127 1 132129 3 132527 24 132621 16 133027 23 133119 22 133528 22 133619 27 134028 22 134119 30 134528 22 134618 33 135029 20 135118 35 135529 20 135618 37 136030 20 136117 39 136530 20 136617 41 137031 19 137116 42 137532 18 137615 45 138032 18 138113 48 138533 17 138612 49 139033 17 139111 51 139534 16 139609 53 140035 15 140107 55 140536 14 140605 57 141036 15 141103 59 141537 15 141601 62 142038 15 142099 64 142539 16 142596 68 143040 16 143094 70 143542 16 143590 75 144043 20 144082 83 144544 121 145046 119 145548 118 146050 116 146552 114 147056 110 147561 106 148065 102 148568 99 149072 95 149574 93 150076 92 150577 92 151079 90 151581 38 151625 45 152082 34 152126 46 152585 2 152628 46 153128 48 153629 49 154129 51 154630 51 155130 51 155631 51 156131 53 156632 53 157133 51 157634 18 157655 29 158135 15 158156 28 158636 13 158657 26 159137 10 159157 26 159637 8 159658 25 160140 2 160158 25 160659 24 161160 22 161661 20 162162 18 162663 15 163165 10 163668 4 174407 2" }, { "index": 20, "mask": "83446 3 83450 2 83454 2 83458 2 83462 2 83465 3 83935 1 83938 33 84426 47 84918 55 85408 1 85410 63 85904 69 86396 77 86891 82 87384 89 87877 97 88372 102 88868 106 89363 111 89860 115 90356 120 90853 124 91352 126 91848 131 92344 137 92841 140 93339 143 93837 145 94335 148 94834 149 95331 153 95830 154 96328 156 96826 159 97324 161 97822 163 98320 165 98819 166 99318 167 99817 168 100317 168 100816 169 101316 169 101816 168 102316 168 102815 169 103315 169 103815 169 104315 169 104815 168 105315 168 105815 168 106315 167 106815 167 107316 166 107816 166 108316 166 108816 166 109316 166 109817 164 110317 164 110817 164 111317 164 111774 4 111817 164 112271 8 112317 164 112769 10 112817 164 113267 14 113317 164 113766 15 113817 164 114265 17 114316 165 114764 18 114815 166 115263 21 115314 168 115762 24 115814 168 116262 24 116313 169 116761 25 116813 169 117262 25 117313 170 117763 25 117812 171 118262 27 118311 172 118757 1 118762 28 118809 174 119257 1 119262 31 119309 174 119757 2 119762 32 119808 176 120257 2 120261 36 120300 1 120307 177 120757 2 120761 223 121261 223 121761 223 122261 224 122761 224 123261 224 123761 225 124261 225 124761 225 125261 226 125761 226 126261 226 126761 227 127261 228 127761 228 128261 228 128762 227 129262 227 129762 227 130262 227 130762 227 131262 227 131762 227 132262 227 132763 227 133263 227 133763 227 134262 228 134763 227 135263 227 135763 228 136263 228 136763 228 137263 228 137763 228 138263 228 138763 228 139263 229 139763 229 140263 229 140764 228 141264 228 141764 228 142264 228 142764 228 143264 228 143765 227 144265 227 144765 226 145265 226 145765 226 146265 226 146766 225 147266 225 147766 225 148267 224 148767 225 149267 225 149767 224 150268 224 150768 224 151269 223 151769 223 152269 223 152770 222 153270 222 153771 221 154272 220 154773 219 155273 219 155774 218 156276 216 156779 213 157282 210 157785 206 158290 201 158793 198 159298 193 159803 188 160306 185 160808 182 161314 176 161820 169 162332 157 162839 150 163355 133 163859 129 164375 113 164883 104 165392 95 165898 89 166403 84 166907 80 167414 73 167918 69 168419 68 168920 67 169420 67 169920 67 170420 66 170920 66 171420 66 171920 66 172420 65 172920 65 173421 64 173920 65 174419 65 174918 66 175418 65 175918 65 176418 65 176918 64 177419 63 177920 62 178421 60 178923 58 179424 56 179925 55 180426 53 180926 53 181427 51 181928 49 182429 47 182930 45 183431 44 183933 41 184434 39 184935 38 185435 37 185937 35 186438 33 186939 32 187441 30 187942 28 188442 28 188943 26 189446 23 189947 21 190448 20 190950 17 191450 16 191952 14 192454 11 192955 9 193458 3" }, { "index": 21, "mask": "82968 1 83438 34 83931 42 84423 50 84914 60 85406 68 85901 73 86394 80 86886 88 87380 94 87875 99 88370 105 88865 110 89361 114 89858 118 90354 122 90851 127 91348 131 91845 135 92343 138 92840 142 93338 145 93836 147 94334 150 94832 152 95330 154 95828 156 96326 159 96824 161 97323 162 97821 164 98319 166 98818 167 99318 167 99817 168 100317 168 100816 169 101316 169 101815 170 102315 170 102815 170 103203 3 103314 171 103703 6 103814 170 104202 10 104314 170 104702 13 104814 170 105202 15 105314 169 105702 18 105815 168 106202 20 106315 167 106701 22 106815 167 107201 23 107316 166 107700 25 107816 166 108199 28 108316 166 108697 33 108816 166 109196 35 109316 166 109695 40 109817 165 110194 46 110317 165 110693 50 110817 164 111192 53 111275 3 111317 164 111692 55 111771 9 111817 164 112191 57 112269 13 112317 164 112690 59 112768 14 112817 164 113189 62 113266 16 113317 164 113687 65 113765 18 113816 165 114185 69 114262 21 114315 167 114684 100 114814 168 115183 102 115314 168 115683 103 115813 169 116182 105 116313 169 116682 105 116813 170 117181 108 117312 171 117680 110 117811 172 118178 113 118310 173 118676 116 118809 174 119173 121 119308 176 119672 123 119808 176 120172 312 120671 314 121170 315 121669 316 122168 317 122667 318 123165 321 123663 323 124162 325 124658 329 125156 332 125656 332 126157 332 126658 331 127159 330 127661 328 128161 328 128662 328 129162 328 129662 328 130162 328 130662 328 131163 327 131663 327 132163 327 132663 327 133163 327 133663 327 134164 326 134664 327 135164 327 135665 327 136165 327 136665 327 137166 326 137666 326 138165 327 138665 327 139164 328 139664 328 140163 329 140663 329 141163 329 141664 328 142164 328 142665 327 143165 327 143665 327 144165 327 144666 326 145166 326 145666 326 146167 325 146667 325 147167 325 147668 324 148168 324 148668 324 149169 323 149669 323 150169 323 150670 322 151171 321 151672 320 152173 319 152677 315 153178 314 153680 312 154181 311 154683 310 155184 308 155685 307 156187 305 156690 302 157192 79 157276 216 157696 67 157781 211 158202 59 158285 207 158720 36 158789 203 159292 200 159797 195 160300 191 160804 187 161308 182 161814 176 162320 169 162829 160 163342 147 163851 137 164358 130 164876 112 165384 104 165893 95 166400 88 166904 84 167408 80 167914 74 168417 71 168918 69 169418 69 169919 68 170419 68 170919 68 171419 67 171919 67 172419 67 172919 67 173419 66 173918 67 174417 68 174916 68 175416 68 175916 68 176416 67 176917 66 177418 65 177919 63 178420 62 178921 60 179423 58 179924 56 180425 55 180926 53 181427 52 181927 51 182428 49 182930 46 183431 44 183932 42 184433 41 184934 39 185435 38 185936 36 186438 34 186939 32 187440 31 187941 30 188442 28 188943 27 189444 25 189946 22 190447 21 190949 18 191450 17 191951 15 192452 14 192955 10 193456 7 193959 2" }, { "index": 22, "mask": "54243 5 54740 10 55238 13 55736 17 56234 20 56732 23 57231 25 57729 28 58228 30 58727 32 59225 35 59724 37 60223 39 60721 42 61220 43 61719 46 62217 48 62716 50 63215 52 63714 54 64213 56 64712 58 65211 60 65709 62 66208 64 66707 67 67206 68 67705 70 68204 72 68703 74 69202 76 69700 78 70200 79 70699 81 71198 83 71697 44 71744 38 72196 43 72247 35 72695 42 72748 35 73194 42 73249 35 73693 42 73751 34 74192 41 74252 34 74691 41 74753 33 75190 42 75254 33 75689 42 75755 32 76189 41 76256 32 76688 40 76757 32 77187 40 77258 32 77686 41 77759 31 78185 40 78260 31 78684 40 78761 31 79183 41 79262 31 79682 41 79763 30 80181 41 80264 30 80680 40 80765 29 81178 42 81266 29 81677 42 81767 28 82176 41 82268 28 82674 42 82769 28 83173 42 83270 28 83439 32 83672 42 83771 28 83932 40 84171 41 84272 28 84423 50 84669 42 84773 27 84915 58 85168 43 85274 27 85407 67 85667 43 85775 26 85902 72 86166 42 86275 27 86395 79 86665 43 86776 27 86887 87 87164 43 87276 27 87380 94 87663 43 87777 27 87875 99 88162 42 88278 27 88370 105 88661 43 88779 26 88865 110 89159 44 89280 26 89362 113 89659 43 89780 27 89858 118 90158 43 90281 27 90355 121 90657 43 90782 26 90851 126 91156 44 91282 27 91348 131 91655 44 91783 26 91845 135 92140 3 92154 43 92284 26 92343 138 92637 9 92653 43 92785 25 92840 142 93135 12 93151 45 93286 25 93338 144 93633 62 93786 25 93836 147 94131 63 94287 25 94334 149 94630 63 94788 25 94832 152 95129 64 95288 25 95330 154 95603 14 95627 66 95789 24 95829 156 96100 21 96125 68 96290 24 96327 159 96488 13 96597 96 96791 24 96825 176 97095 98 97291 24 97323 178 97593 100 97791 25 97820 181 98091 102 98292 24 98318 183 98590 104 98792 209 99089 106 99293 208 99588 108 99793 208 100087 110 100294 207 100586 112 100793 208 101085 114 101293 208 101584 116 101792 209 102081 122 102291 210 102580 124 102790 211 103078 129 103289 212 103562 148 103788 213 104058 155 104287 214 104556 160 104786 215 105055 164 105285 216 105552 168 105784 217 106050 172 106284 217 106549 174 106783 218 107048 176 107282 219 107546 180 107781 220 108045 183 108280 221 108544 187 108779 222 109043 190 109278 223 109541 195 109778 223 110040 201 110278 223 110540 203 110778 223 111038 208 111273 228 111537 210 111771 230 112036 213 112269 232 112535 215 112768 233 113034 218 113266 235 113533 221 113764 237 114033 468 114533 468 115032 469 115532 469 116031 470 116531 470 117030 471 117530 471 118029 472 118529 472 119029 472 119528 471 120028 460 120528 458 121028 457 121527 458 122027 459 122527 459 123026 460 123526 460 124026 461 124526 461 125026 462 125526 462 126026 463 126525 464 127025 464 127526 463 128026 463 128526 464 129026 464 129526 464 130026 464 130526 464 131026 464 131527 463 132027 463 132527 463 133028 462 133528 462 134028 462 134529 462 135029 462 135529 462 136030 462 136531 461 137031 461 137532 460 138032 461 138533 460 139034 459 139534 459 140035 458 140536 456 141037 455 141538 455 142039 454 142540 453 143041 451 143542 450 144043 449 144545 447 145046 446 145548 444 146050 442 146554 438 147057 435 147561 431 148066 426 148569 423 149072 420 149574 418 150076 416 150578 414 151079 413 151581 38 151625 367 152083 32 152126 366 152627 365 153128 364 153629 363 154129 364 154630 363 155130 362 155631 361 156132 360 156632 360 157133 52 157190 302 157634 50 157694 298 158135 16 158155 28 158199 293 158636 12 158657 26 158707 285 159137 10 159157 25 159254 238 159638 7 159658 24 159761 231 160159 23 160265 226 160659 22 160770 221 161160 20 161276 214 161661 18 161782 208 162162 15 162293 196 162664 12 162810 3 162816 173 163166 7 163326 163 163839 149 164344 144 164847 141 165351 137 165856 132 166359 129 166861 127 167365 123 167869 119 168372 116 168874 115 169376 115 169877 116 170379 116 170881 116 171384 115 171887 114 172388 113 172891 110 173393 108 173895 106 174397 104 174903 98 175408 93 175915 86 176416 85 176917 84 177418 83 177919 82 178420 81 178922 79 179423 78 179924 77 180425 76 180926 75 181427 74 181927 74 182429 72 182930 71 183431 70 183932 69 184433 68 184935 66 185436 65 185937 64 186438 63 186939 62 187440 61 187941 60 188442 59 188943 58 189445 56 189946 55 190448 53 190949 52 191451 50 191952 15 191970 31 192453 13 192471 30 192956 8 192973 28 193457 5 193475 26 193978 23 194479 22 194981 20 195483 18 195986 15 196487 14 196990 11" }, { "index": 23, "mask": "1 53243 53248 492 53750 487 54253 482 54754 480 55254 479 55755 476 56256 473 56757 471 57259 467 57760 465 58261 462 58762 460 59263 458 59763 457 60264 455 60765 453 61266 450 61768 447 62268 446 62769 444 63270 441 63771 439 64272 437 64773 435 65273 433 65774 432 66275 430 66776 427 67277 425 67778 423 68279 421 68780 419 69280 418 69781 416 70282 414 70783 412 71284 410 71785 408 72285 407 72741 2 72786 405 73240 6 73287 403 73738 10 73787 403 74238 11 74288 401 74737 13 74788 400 75235 16 75289 398 75734 18 75790 396 76232 22 76291 394 76731 24 76792 392 77231 25 77292 391 77730 27 77793 390 78229 28 78294 388 78728 30 78794 386 79227 32 79295 384 79726 34 79795 383 80224 38 80296 381 80724 39 80797 378 81223 41 81298 376 81722 43 81798 149 81958 6 81972 201 82221 44 82299 137 82474 198 82720 46 82800 132 82975 195 83218 49 83301 123 83475 194 83717 51 83801 116 83975 193 84216 53 84302 105 84476 191 84715 55 84802 100 84976 189 85214 57 85303 91 85477 187 85713 59 85804 82 85977 186 86212 60 86304 76 86477 185 86711 62 86805 72 86978 183 87210 64 87306 64 87478 182 87709 66 87806 59 87978 181 88208 68 88307 54 88478 180 88707 70 88808 50 88979 178 89206 71 89309 45 89479 177 89705 73 89809 41 89980 175 90204 74 90310 38 90481 173 90703 76 90810 36 90982 158 91141 12 91202 78 91311 32 91482 155 91646 6 91701 80 91811 29 91983 151 92200 82 92312 25 92485 148 92699 84 92813 22 92985 146 93199 84 93313 20 93486 143 93698 86 93814 17 93987 141 94198 87 94314 15 94490 8 94501 101 94617 10 94697 88 94815 12 95001 99 95122 2 95196 90 95316 10 95501 96 95695 92 95817 6 96001 94 96195 93 96317 4 96501 92 96695 93 97001 90 97195 94 97501 89 97696 93 98001 87 98197 93 98501 87 98698 92 99001 86 99199 92 99501 85 99700 91 100001 84 100201 90 100501 82 100702 88 101001 80 101204 85 101501 78 101707 82 102001 75 102208 80 102501 62 102710 77 103001 58 103213 73 103501 55 103716 69 104001 54 104219 65 104501 52 104722 61 105001 50 105224 58 105501 48 105725 56 106001 46 106226 54 106501 45 106727 52 107001 44 107229 49 107501 42 107732 45 108001 42 108233 44 108501 40 108737 39 109001 39 109242 33 109501 38 109745 28 110001 37 110247 25 110501 36 110748 23 111001 35 111250 19 111501 34 111752 15 112001 33 112254 11 112501 32 113001 31 113501 30 114001 30 114501 30 115001 29 115501 28 116001 28 116501 28 117001 27 117501 27 118001 27 118501 27 119001 26 119501 26 120001 26 120501 25 121001 25 121498 1 121501 24 121990 35 122490 35 122990 35 123490 35 123991 33 124491 33 124991 33 125491 33 125991 33 126492 32 126992 32 127492 32 127992 32 128493 31 128993 31 129493 31 129993 32 130493 32 130993 32 131493 32 131993 32 132493 32 132993 33 133494 32 133994 32 134494 33 134994 33 135494 34 135995 33 136495 33 136995 34 137496 34 137996 34 138496 35 138996 36 139496 36 139996 37 140496 37 140996 38 141496 39 141996 40 142496 41 142996 42 143496 43 143996 44 144496 45 144996 47 145496 48 145996 50 146495 53 146995 56 147495 58 147995 62 148495 67 148995 69 149495 71 149995 74 150495 77 150995 80 151495 82 151996 82 152496 84 152996 86 153117 8 153496 89 153587 22 153610 3 153614 12 153996 131 154496 131 154996 132 155496 132 155996 133 156496 133 156995 135 157495 135 157995 137 158495 138 158689 6 158995 139 159187 13 159495 140 159650 4 159687 20 159995 141 160148 7 160186 65 160494 143 160646 10 160686 69 160994 163 161186 76 161494 163 161685 80 161994 164 162184 87 162493 167 162683 93 162993 168 163181 104 163492 170 163679 113 163794 2 163992 172 164177 131 164492 175 164675 146 164992 343 165492 347 165992 353 166492 358 166992 363 167492 367 167994 369 168495 372 168998 372 169501 370 170001 373 170501 375 171001 377 171501 379 172001 382 172501 383 173001 385 173501 387 174001 389 174501 391 175001 393 175501 398 176001 404 176501 409 177001 412 177501 414 178001 415 178501 417 179001 418 179501 419 180001 420 180501 422 181001 423 181501 424 182001 425 182501 426 183001 426 183501 428 184001 429 184501 430 185001 432 185501 433 186001 434 186501 435 187001 436 187501 437 188001 438 188501 439 189001 440 189501 441 190001 442 190501 444 191001 445 191501 446 192001 447 192501 449 193001 450 193501 452 193967 5 194001 454 194466 8 194501 456 194965 12 195001 458 195462 17 195501 479 196001 481 196501 483 197001 485 197501 488 198001 493 198501 499 199001 51000" }] }




        layers = res.mask_list.map((item) =>
            transformMaskImage(item, res.width, res.height)
        );
        const box = document.querySelector("#layer-box");
        const baseStyle = "width:100%;height:100%;position: absolute;";
        //将各个mask添加为layer-box的子组件，并隐藏mask的展示
        layers.forEach((ele) => {
            const image = document.createElement("img");
            image.src = ele.imageData;
            image.style = `${baseStyle}opacity:0`;
            image.className = "layer";
            box.append(image);
        });

        // 鼠标移入mask组件的区域时，展示mask
        box.addEventListener("mousemove", (e) => {
            const { clientX, clientY } = e;
            const X = box.getBoundingClientRect().left + document.body.scrollLeft;
            const Y = box.getBoundingClientRect().top + document.body.scrollTop;
            const x = parseInt(res.width * (clientX - X) / box.getBoundingClientRect().width)
            const y = parseInt(res.height * (clientY - Y) / box.getBoundingClientRect().height)
            const allLayers = box.querySelectorAll(".layer");
            const index = layers.findIndex((item) => item.matrix?.[y]?.[x]);
            allLayers.forEach((ele, i) => {
                if (i === index) {
                    ele.style = `${baseStyle}opacity:0.7`;
                } else {
                    // 已经选中的不需要隐藏
                    if (selectedIndexList.indexOf(i) === -1) {
                        ele.style = `${baseStyle}opacity:0`;
                    }
                }
            });
        });

        // 鼠标移出mask组件的区域时，隐藏mask
        box.addEventListener("mouseout", (e) => {
            console.log('mouseout selectedIndexList', selectedIndexList);
            const allLayers = box.querySelectorAll(".layer");
            allLayers.forEach((ele, i) => {
                // 只有选中的才会展示
                if (selectedIndexList.indexOf(i) > -1) {
                    ele.style = `${baseStyle}opacity:0.7`;
                } else {
                    ele.style = `${baseStyle}opacity:0`;
                }
            });
        });

        // 用户点击时，保存用户选中的mask的index
        box.addEventListener("mousedown", (e) => {
            const { clientX, clientY } = e;
            const X = box.getBoundingClientRect().left + document.body.scrollLeft;
            const Y = box.getBoundingClientRect().top + document.body.scrollTop;
            const x = parseInt(res.width * (clientX - X) / box.getBoundingClientRect().width)
            const y = parseInt(res.height * (clientY - Y) / box.getBoundingClientRect().height)
            const index = layers.findIndex((item) => item.matrix?.[y]?.[x]);
            if (selectedIndexList.indexOf(index) === -1) {
                //保存点击选中的元素index
                selectedIndexList.push(index)
            }
        });
    </script>
</body>

</html>
